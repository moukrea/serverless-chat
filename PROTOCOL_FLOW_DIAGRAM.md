# Peer Reconnection Protocol - Visual Flow Diagrams

## 1. Initial Connection & Trust Establishment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Peer A    â”‚                                    â”‚   Peer B    â”‚
â”‚             â”‚                                    â”‚             â”‚
â”‚ [Generate]  â”‚                                    â”‚ [Generate]  â”‚
â”‚  Ed25519    â”‚                                    â”‚  Ed25519    â”‚
â”‚  ECDH Keys  â”‚                                    â”‚  ECDH Keys  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                  â”‚
       â”‚ 1. WebRTC Offer/Answer (via signaling)         â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                  â”‚
       â”‚ 2. DTLS Encryption Established                  â”‚
       â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
       â”‚                                                  â”‚
       â”‚ 3. Identity Exchange                            â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
       â”‚  â”‚ type: 'identity_exchange'                â”‚  â”‚
       â”‚  â”‚ peerId: 'A'                              â”‚  â”‚
       â”‚  â”‚ signPublicKey: pk_A                      â”‚  â”‚
       â”‚  â”‚ dhPublicKey: dh_A                        â”‚  â”‚
       â”‚  â”‚ signature: Sign(sk_A, {peerId, pk_A...}) â”‚  â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                                                  â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
       â”‚  â”‚ type: 'identity_exchange'                â”‚  â”‚
       â”‚  â”‚ peerId: 'B'                              â”‚  â”‚
       â”‚  â”‚ signPublicKey: pk_B                      â”‚  â”‚
       â”‚  â”‚ dhPublicKey: dh_B                        â”‚  â”‚
       â”‚  â”‚ signature: Sign(sk_B, {peerId, pk_B...}) â”‚  â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚                                                  â”‚
       â”‚ 4. Verify Signatures                            â”‚
       â”‚  Verify(pk_B, signature_B, payload_B) â†’ TRUE    â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                  â”‚ Verify(pk_A, signature_A, payload_A) â†’ TRUE
       â”‚                                                  â”‚
       â”‚ 5. Store in Trust Store (TOFU)                  â”‚
       â”‚  trustStore[B] = { pk_B, firstSeen: now }       â”‚
       â”‚                                                  â”‚ trustStore[A] = { pk_A, firstSeen: now }
       â”‚                                                  â”‚
       â”‚ 6. Derive Shared Secret                         â”‚
       â”‚  secret_AB = ECDH(sk_dh_A, pk_dh_B)             â”‚
       â”‚                                                  â”‚ secret_BA = ECDH(sk_dh_B, pk_dh_A)
       â”‚                                                  â”‚ (secret_AB == secret_BA)
       â”‚                                                  â”‚
       â”‚ 7. Regular Communication                        â”‚
       â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
       â”‚        (Encrypted via WebRTC DTLS)              â”‚
       â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
       â”‚                                                  â”‚
```

---

## 2. IP Address Change & Reconnection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Peer A    â”‚                                    â”‚   Peer B    â”‚
â”‚             â”‚                                    â”‚             â”‚
â”‚  Connected  â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚  Connected  â”‚
â”‚             â”‚                                    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                  â”‚
       â”‚                                                  â”‚ [Network Change!]
       â”‚                                                  â”‚ 4G â†’ WiFi
       â”‚                                                  â”‚ IP: 1.2.3.4 â†’ 5.6.7.8
       â”‚                                                  â”‚
       â”‚ [Connection Lost]                               â”‚ [Connection Lost]
       â”‚ peer.on('close')                                â”‚ peer.on('close')
       â”‚                                                  â”‚
       â”‚                                                  â”‚ [Create Announcement]
       â”‚                                                  â”‚ seq++ (42 â†’ 43)
       â”‚                                                  â”‚ nonce = random(32 bytes)
       â”‚                                                  â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
       â”‚  â”‚ type: 'peer_reconnection'                â”‚  â”‚
       â”‚  â”‚ peerId: 'B'                              â”‚  â”‚
       â”‚  â”‚ timestamp: 1700000000000                 â”‚  â”‚
       â”‚  â”‚ nonce: '7f3a8e9c...'                     â”‚  â”‚
       â”‚  â”‚ sequenceNum: 43                          â”‚  â”‚
       â”‚  â”‚ previousConnections: ['A', 'C']          â”‚  â”‚
       â”‚  â”‚ signature: Sign(sk_B, {peerId, ts...})   â”‚  â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚               (via DHT or relay)                â”‚
       â”‚                                                  â”‚
       â”‚ [Verify Announcement]                           â”‚
       â”‚ 1. Check timestamp (< 5 min old?) âœ“             â”‚
       â”‚ 2. Check nonce (seen before?) âœ“                 â”‚
       â”‚ 3. Check sequence (> last seen?) âœ“              â”‚
       â”‚ 4. Verify signature with stored pk_B âœ“          â”‚
       â”‚                                                  â”‚
       â”‚ result = { valid: true, peerId: 'B' }           â”‚
       â”‚                                                  â”‚
       â”‚ [Initiate Reconnection]                         â”‚
       â”‚ connectToPeer('B')                              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚ WebRTC Offer                                    â”‚
       â”‚                                                  â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ WebRTC Answer                                   â”‚
       â”‚                                                  â”‚
       â”‚ [New Connection Established]                    â”‚
       â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
       â”‚                                                  â”‚
       â”‚ [Exchange Identity Again]                       â”‚
       â”‚ (same keys, verify consistency)                 â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                                                  â”‚
       â”‚ [Verify Keys Match Trust Store]                 â”‚
       â”‚ if (pk_B != trustStore[B].pk) â†’ ALERT USER     â”‚
       â”‚ else â†’ Continue                                 â”‚
       â”‚                                                  â”‚
```

---

## 3. Replay Attack Prevention

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Attacker   â”‚                                    â”‚   Peer A    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                  â”‚
       â”‚ [Capture Announcement at T=0]                   â”‚
       â”‚  { peerId: 'B', timestamp: T0,                  â”‚
       â”‚    nonce: N1, sequenceNum: 42,                  â”‚
       â”‚    signature: Ïƒ }                               â”‚
       â”‚                                                  â”‚
       â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€[Captured]       â”‚
       â”‚                                                  â”‚
       â”‚ [Replay at T=6min]                              â”‚
       â”‚  Same announcement, stale timestamp             â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                                                  â”‚
       â”‚                                                  â”‚ [Timestamp Check]
       â”‚                                                  â”‚ age = now - T0 = 6 min
       â”‚                                                  â”‚ if (age > 5 min) â†’ REJECT âœ—
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ { valid: false, reason: 'timestamp_out_of_range' }
       â”‚                                                  â”‚
       â”‚ [Replay Immediately at T=1sec]                  â”‚
       â”‚  Within 5-minute window                         â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                                                  â”‚
       â”‚                                                  â”‚ [Nonce Check]
       â”‚                                                  â”‚ if (nonceCache.has(N1)) â†’ REJECT âœ—
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ { valid: false, reason: 'nonce_reused' }        â”‚
       â”‚                                                  â”‚
       â”‚ [Replay Old Sequence]                           â”‚
       â”‚  Old announcement with seq=42                   â”‚
       â”‚  (current seq for B is 50)                      â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                                                  â”‚
       â”‚                                                  â”‚ [Sequence Check]
       â”‚                                                  â”‚ if (42 <= 50) â†’ REJECT âœ—
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ { valid: false, reason: 'sequence_not_incremented' }
       â”‚                                                  â”‚
```

---

## 4. Multi-Hop Relay

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Peer B    â”‚      â”‚   Peer C    â”‚      â”‚   Peer A    â”‚
â”‚  (Mobile)   â”‚      â”‚  (Relay)    â”‚      â”‚  (Desktop)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                     â”‚
       â”‚ [New IP, cannot reach A directly]       â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Create Announcement]                   â”‚
       â”‚  announcement_B    â”‚                     â”‚
       â”‚  signature: Sign(sk_B, ...)             â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Send to C]        â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                    â”‚
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [Verify B's Signature]
       â”‚                    â”‚ Verify(pk_B, Ïƒ_B, announcement_B) âœ“
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [Create Relay Envelope]
       â”‚                    â”‚  envelope = {       â”‚
       â”‚                    â”‚    relayedBy: 'C',  â”‚
       â”‚                    â”‚    relayTimestamp: now,
       â”‚                    â”‚    originalAnnouncement: announcement_B,
       â”‚                    â”‚    relaySignature: Sign(sk_C, {
       â”‚                    â”‚      relayedBy, relayTimestamp,
       â”‚                    â”‚      hash(announcement_B)
       â”‚                    â”‚    })                â”‚
       â”‚                    â”‚  }                   â”‚
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [Forward to A]      â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚ [Verify Relay Signature]
       â”‚                    â”‚                     â”‚ Verify(pk_C, Ïƒ_C, relayPayload) âœ“
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚ [Verify Original Signature]
       â”‚                    â”‚                     â”‚ Verify(pk_B, Ïƒ_B, announcement_B) âœ“
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚ [Both Valid!]
       â”‚                    â”‚                     â”‚ result = { valid: true,
       â”‚                    â”‚                     â”‚            peerId: 'B',
       â”‚                    â”‚                     â”‚            relayedBy: 'C' }
       â”‚                    â”‚                     â”‚
       â”‚ [A initiates reconnection to B]         â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                    â”‚                     â”‚
```

---

## 5. Malicious Relay Detection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Peer B    â”‚      â”‚ Evil Peer M â”‚      â”‚   Peer A    â”‚
â”‚  (Honest)   â”‚      â”‚ (Malicious) â”‚      â”‚  (Honest)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                     â”‚
       â”‚ [Create Announcement]                   â”‚
       â”‚  { peerId: 'B',    â”‚                     â”‚
       â”‚    sequenceNum: 42,â”‚                     â”‚
       â”‚    signature: Ïƒ_B }â”‚                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                    â”‚
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [Malicious Modification]
       â”‚                    â”‚ announcement_modified = {
       â”‚                    â”‚   peerId: 'B',       â”‚
       â”‚                    â”‚   sequenceNum: 99, â† CHANGED!
       â”‚                    â”‚   signature: Ïƒ_B   â† Original signature!
       â”‚                    â”‚ }                    â”‚
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [Forward Modified]  â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚ [Verify Signature]
       â”‚                    â”‚                     â”‚ payload = { peerId: 'B',
       â”‚                    â”‚                     â”‚             sequenceNum: 99 }
       â”‚                    â”‚                     â”‚ Verify(pk_B, Ïƒ_B, payload) â†’ FALSE âœ—
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚ [Signature Invalid!]
       â”‚                    â”‚                     â”‚ result = { valid: false,
       â”‚                    â”‚                     â”‚            reason: 'invalid_signature' }
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚ [Ban Malicious Relay]
       â”‚                    â”‚                     â”‚ banPeer('M')
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                    â”‚ Disconnect          â”‚
       â”‚                    â”‚                     â”‚
```

---

## 6. Man-in-the-Middle Detection (First Connection)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Peer A    â”‚      â”‚  Attacker   â”‚      â”‚   Peer B    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                     â”‚
       â”‚ [WebRTC Offer]     â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                    â”‚
       â”‚                    â”‚ [Intercept]         â”‚
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [WebRTC Offer]      â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [WebRTC Answer]     â”‚
       â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                    â”‚                     â”‚
       â”‚ [WebRTC Answer]    â”‚                     â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Two Connections: Aâ†”Attacker, Attackerâ†”B]
       â”‚                    â”‚                     â”‚
       â”‚ [Identity Exchange]â”‚                     â”‚
       â”‚  pk_B_fake         â”‚                     â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚ (Attacker's key, not B's!)
       â”‚                    â”‚                     â”‚
       â”‚ [Trust Store]      â”‚                     â”‚
       â”‚ trustStore[B] = pk_B_fake âœ— (WRONG!)   â”‚
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [User: Compare Fingerprints Out-of-Band]
       â”‚                    â”‚                     â”‚
       â”‚ Phone Call: "What's your fingerprint?"  â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                    â”‚                     â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ "042 193 251 087..."â”‚                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Compare with Displayed Fingerprint]    â”‚
       â”‚ displayed = hash(pk_B_fake) = "999 888 777..."
       â”‚ received  = "042 193 251..."             â”‚
       â”‚                    â”‚                     â”‚
       â”‚ MISMATCH! â†’ ğŸš¨ ALERT USER                â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Disconnect & Block Attacker]           â”‚
       â”‚ Xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€X                     â”‚
       â”‚                    â”‚                     â”‚
```

---

## 7. TOFU Key Pinning (Subsequent Connections)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Peer A    â”‚      â”‚  Attacker   â”‚      â”‚   Peer B    â”‚
â”‚             â”‚      â”‚             â”‚      â”‚   (Real)    â”‚
â”‚ trustStore[B]â”‚      â”‚             â”‚      â”‚             â”‚
â”‚ = pk_B_real â”‚      â”‚             â”‚      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚                     â”‚ [Real B disconnects]
       â”‚                    â”‚                     â”‚
       â”‚                    â”‚ [Attacker tries to impersonate B]
       â”‚ [Identity Exchange]â”‚                     â”‚
       â”‚  pk_B_fake         â”‚                     â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Check Trust Store]â”‚                     â”‚
       â”‚ stored = trustStore[B].pk = pk_B_real   â”‚
       â”‚ received = pk_B_fake                    â”‚
       â”‚                    â”‚                     â”‚
       â”‚ if (stored != received) {               â”‚
       â”‚   throw new Error('PUBLIC_KEY_MISMATCH');
       â”‚ }                  â”‚                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚ ğŸš¨ SECURITY ALERT! â”‚                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Disconnect Attacker]                   â”‚
       â”‚ Xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€X                     â”‚
       â”‚                    â”‚                     â”‚
       â”‚ [Show Warning to User]                  â”‚
       â”‚ "âš ï¸ Peer B is using a different key!"   â”‚
       â”‚ "This could be an attack!"              â”‚
       â”‚                    â”‚                     â”‚
```

---

## 8. Complete Flow with Timeline

```
Time: T=0 (Initial Connection)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Peer A                    Network                    Peer B
  â”‚                                                     â”‚
  â”‚ [Generate Keys]                                    â”‚ [Generate Keys]
  â”‚ - Ed25519 (signing)                                â”‚ - Ed25519 (signing)
  â”‚ - ECDH (key agreement)                             â”‚ - ECDH (key agreement)
  â”‚                                                     â”‚
  â”‚ WebRTC Offer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
  â”‚                                                     â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WebRTC Answer
  â”‚                                                     â”‚
  â”‚ [DTLS Encrypted Channel] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â”‚                                                     â”‚
  â”‚ Identity Exchange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
  â”‚  { peerId, pk_sign, pk_dh, signature }             â”‚
  â”‚                                                     â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Identity Exchange â”‚
  â”‚                          { peerId, pk_sign, pk_dh, signature }
  â”‚                                                     â”‚
  â”‚ [Verify & Store]                                   â”‚ [Verify & Store]
  â”‚ trustStore[B] = pk_B                               â”‚ trustStore[A] = pk_A
  â”‚                                                     â”‚
  â”‚ [Regular Communication] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º
  â”‚                                                     â”‚

Time: T=10min (IP Change)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚                                                     â”‚
  â”‚                                                     â”‚ [Network Switch]
  â”‚                                                     â”‚ 4G â†’ WiFi
  â”‚                                                     X Connection Lost
  X Connection Lost                                     â”‚
  â”‚                                                     â”‚
  â”‚                                                     â”‚ seq++ (5 â†’ 6)
  â”‚                                                     â”‚ nonce = random()
  â”‚                                                     â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Announcement (via DHT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  { peerId: B, seq: 6, nonce, timestamp, signature }â”‚
  â”‚                                                     â”‚
  â”‚ [Verify Signature] âœ“                               â”‚
  â”‚ [Check Timestamp] âœ“ (< 5min)                       â”‚
  â”‚ [Check Nonce] âœ“ (not seen)                         â”‚
  â”‚ [Check Sequence] âœ“ (6 > 5)                         â”‚
  â”‚                                                     â”‚
  â”‚ WebRTC Offer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
  â”‚                                                     â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WebRTC Answer
  â”‚                                                     â”‚
  â”‚ [DTLS Encrypted Channel] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â”‚                                                     â”‚
  â”‚ [Exchange Identity Again]                          â”‚
  â”‚ [Verify Keys Match Trust Store] âœ“                  â”‚
  â”‚                                                     â”‚
  â”‚ [Reconnected!] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º
  â”‚                                                     â”‚

Time: T=10min+1sec (Replay Attack)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚                                                     â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Replayed Announcement â”€â”€â”€â”€â”€â”€â”€Attacker â”‚
  â”‚  { peerId: B, seq: 6, nonce, timestamp, signature }â”‚
  â”‚  (same nonce as before!)                           â”‚
  â”‚                                                     â”‚
  â”‚ [Check Nonce] âœ— (already seen!)                   â”‚
  â”‚ REJECT: 'nonce_reused'                             â”‚
  â”‚                                                     â”‚
  X Block Attacker                                     â”‚
  â”‚                                                     â”‚
```

---

## 9. State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PEER AUTHENTICATION                       â”‚
â”‚                      STATE MACHINE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  UNINITIALIZEDâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ initialize()
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   READY       â”‚
                    â”‚ (Keys Generated)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                 â”‚                 â”‚
          â”‚ exchangeIdentity()                â”‚
          â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”‚          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ VERIFYINGâ”‚            â”‚          â”‚ CREATING â”‚
    â”‚ IDENTITY â”‚            â”‚          â”‚ANNOUNCEMENTâ”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â”‚          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                 â”‚                â”‚
          â”‚ valid?          â”‚                â”‚
          â”‚                 â”‚                â”‚
    YES â”Œâ”€â”´â”€â” NO            â”‚                â”‚
    â”€â”€â”€â”€â–º   â”œâ”€â”€â”€â–ºREJECTED   â”‚                â”‚
        â”‚   â”‚               â”‚                â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â”           â”‚          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  TRUSTED  â”‚           â”‚          â”‚ ANNOUNCED â”‚
    â”‚ (TOFU Store)          â”‚          â”‚ (Broadcast)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                â”‚
          â”‚                 â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CONNECTED    â”‚
                    â”‚ (Active Peer) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ on('close')
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ DISCONNECTED  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ createAnnouncement()
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ANNOUNCING   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ verifyAnnouncement()
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  RECONNECTING â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ exchangeIdentity()
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CONNECTED    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     KEY MATERIAL FLOW                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    crypto.subtle.generateKey()
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
      â”‚  Sign Key Pair â”‚            â”‚  DH Key Pair  â”‚
      â”‚   (Ed25519)    â”‚            â”‚  (ECDH P-256) â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚                               â”‚
              â”‚ exportKey('jwk')              â”‚ exportKey('jwk')
              â”‚                               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
      â”‚ Public/Private â”‚            â”‚ Public/Privateâ”‚
      â”‚    JWK Keys    â”‚            â”‚   JWK Keys    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚                               â”‚
              â”‚ encryptForStorage()           â”‚ encryptForStorage()
              â”‚                               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
      â”‚         AES-GCM Encrypted Blob              â”‚
      â”‚      (key derived from browser entropy)     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ localStorage.setItem()
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚     localStorage['mesh_reconnection_        â”‚
      â”‚           _identity']                       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ANNOUNCEMENT VERIFICATION                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      Received Announcement
              â”‚
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Parse JSON     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Timestamp      â”‚
      â”‚ Validation     â”‚â”€â”€â”€NOâ”€â”€â–º REJECT
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ YES
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Nonce Cache    â”‚
      â”‚ Lookup         â”‚â”€â”€â”€SEENâ”€â”€â–º REJECT (replay)
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ NOT SEEN
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Sequence       â”‚
      â”‚ Number Check   â”‚â”€â”€â”€OLDâ”€â”€â–º REJECT (rollback)
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ INCREMENTED
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Trust Store    â”‚
      â”‚ Lookup peerId  â”‚â”€â”€â”€UNKNOWNâ”€â”€â–º REJECT (untrusted)
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ TRUSTED
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Get Public Key â”‚
      â”‚ from Trust     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Verify         â”‚
      â”‚ Signature      â”‚â”€â”€â”€INVALIDâ”€â”€â–º REJECT (forgery)
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ VALID
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Update Nonce   â”‚
      â”‚ Cache & Seq    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ACCEPT         â”‚
      â”‚ Announcement   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Visual Diagrams Version**: 1.0
**Protocol Version**: 1.0
**Last Updated**: 2025-01-21
